---
title: "--"
output:
 rmdformats::readthedown:
    self_contained: true
    thumbnails: false
    lightbox: false
    gallery: true
    highlight: tango
---

Here, I'll be adding graphs and other visuals made in R on a variety of topics.  I'm working on improving my R skills and enjoy trying out new packages and visualization tools, so these graphs are in no way meant to be professional quality and are simply a way for me to post my progress in this small portfolio.  I've included data sources and a short description of each graph below. Enjoy!  

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```

```{r include=FALSE}
library(tidyverse)
library(dplyr)
library(magrittr) 
library(psych)
library(foreign)
library(car)
library(data.table)
library(knitr)
library(ggplot2)
library(broom) 
library(tidyr)
library(plotly)
library(broom)
library(readxl)
library(tibble)
library(janitor)
library(plotly)
library(hrbrthemes)
library(mFilter)
library(xts)
library(dygraphs)
library(scales)
library(htmlwidgets)
library(gapminder)
library(gganimate)
library(babynames)
library(hrbrthemes)
library(viridis)
library(gifski)
library(gapminder)
library(png)
library(prettydoc)
library(cowplot)
library(googleway)
library(ggrepel)
library(ggspatial)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(usmap)
library(maps)
library(rmdformats)
library(forcats)


#install.packages("rmdformats")

```
# Slider Controlled Globe
2021 | 01 | 10

In this projection of the globe, I used multiple sliders to latitude and longitude adjustements by the viewer and a variety of projection types to chooose from.  I used the file below to download data on globe contours:

[https://raw.githubusercontent.com/plotly/datasets/master/globe_contours.csv](https://raw.githubusercontent.com/plotly/datasets/master/globe_contours.csv)

To construct this, I followed the Plotly R SLiders tutorial for multiple sliders, and made only a few  modifications, so this is essentially a replication of the tutorial output.  [Plotly.com](https://plotly.com/) has an extensive library of tutorials and code, which I would highly recommend for experimenting with graphing in R. 


```{r include=FALSE}
df <- read.csv('https://raw.githubusercontent.com/plotly/datasets/master/globe_contours.csv')
df$id <- seq_len(nrow(df))

d <- df %>%
  gather(key, value, -id) %>%
  separate(key, c("l", "line"), "\\.") %>%
  spread(l, value)

geo <- list(
  showland = TRUE,
  showlakes = TRUE,
  showcountries = TRUE,
  showocean = TRUE,
  countrywidth = 0.5,
  landcolor = 'rgb(230, 145, 56)',
  lakecolor = 'rgb(0, 255, 255)',
  oceancolor = 'rgb(0, 255, 255)',
  projection = list(
    type = 'orthographic',
    rotation = list(
      lon = -100,
      lat = 40,
      roll = 0
    )
  ),
  lonaxis = list(
    showgrid = TRUE,
    gridcolor = toRGB("gray40"),
    gridwidth = 0.5
  ),
  lataxis = list(
    showgrid = TRUE,
    gridcolor = toRGB("gray40"),
    gridwidth = 0.5
  )
)

## add custom events

# dropdown
projections = data.frame(type = c("equirectangular", "mercator", "orthographic", "natural earth", 
                                  "miller", "robinson", "azimuthal equal area","azimuthal equidistant", 
                                  "conic equal area", "conic conformal", "conic equidistant", "gnomonic",
                                  "mollweide", "transverse mercator", "albers usa", "winkel tripel"))

all_buttons <- list()
for (i in 1:length(projections[,])) { 
  all_buttons[[i]] <- list(method = "relayout",
                           args = list(list(geo.projection.type = projections$type[i])),
                           label = projections$type[i])
}

# sliders
lon_range = data.frame(seq(-180, 180, 10))
lat_range = data.frame(seq(-90, 90, 10))
colnames(lon_range) <- "x"
colnames(lat_range) <- "x"

all_lat <- list()
for (i in 1:length(lat_range[,])) { 
  all_lat[[i]] <- list(method = "relayout",
                       args = list(list(geo.projection.rotation.lat = lat_range$x[i])),
                       label = lat_range$x[i])
}

all_lon <- list()
for (i in 1:length(lon_range[,])) {  
  all_lon[[i]] <- list(method = "relayout", 
                       args = list(list(geo.projection.rotation.lon = lon_range$x[i])),
                       label = lon_range$x[i]) 
} 

# annotations
annot <- list(x = 0, y=0.8, text = "Projection", yanchor = 'bottom', 
              xref = 'paper', xanchor = 'right',
              showarrow = FALSE)


# original d3-globe with contours
fig<- plot_geo(d) 
fig <- fig %>% group_by(line) 
fig <- fig %>% add_lines(x = ~lon, y = ~lat, color = ~line, colors = 'Reds') 
fig <- fig %>% layout(
  showlegend = FALSE, geo = geo
)

# plot with custom events
fig<- fig
fig <- fig %>% layout(annotations = annot,
                      updatemenus = list(list(active = 2, x = 0, y = 0.8, 
                                              buttons=all_buttons)),
                      sliders = list(

                        list(
                          active = (length(lon_range[,])-1)/2, 
                          currentvalue = list(prefix = "Longitude: "), 
                          pad = list(t = 20), 

                          steps = all_lon),

                        list(
                          active = (length(lat_range[,])-1)/2, 
                          currentvalue = list(prefix = "Latitude: "), 
                          pad = list(t = 100), 

                          steps = all_lat)))

```

```{r echo=FALSE}
fig
```


# Global Energy Consumption
2021 | 01 | 09

In this graph, we look at global primary energy consumption by source from 1800 until present, using data from the BP Statistical Review of World Energy.  Consumption has grown most rapidly from the 1950's onward, but over the 200 year span, grew from an estimated 5653 TWh in 1800 to over 170,000 TWh in 2019.  Biomass consumption has remained relatively constant over the entire time period, but was overtaken as the primary energy source by coal in 1910. Oil took off shortly afterwards, and surpassed coal consumption around 1965.  At the same time, gas consumption was rising in popularity and today rivals coal.  Hydropower and nuclear were the first two clean energy sources to be introduced in the mid 1900's, but while hydropower has steadily climbed, nuclear power consumption reached a peak in 2006 and has leveled off since.  Wind and solar power, while barely visible on this graph, have both grown exponentially over the last 20 years and now make up about 3% of global primary energy supply.  Without a doubt, that percentage will be rising steadily in the next 30 years as nations across the globe commit to emission reductions and carbon free energy solutions in efforts to mitigate the impacts of climate change.        

I'm working on some modifications to improve the readability of this graph, but this is it for now.

```{r include=FALSE}
data_dir <-"~/Documents/Dynamic Economics/EViews Graphs/R" 

data08 <- read_csv(file.path(data_dir,
                               "globalenergy.csv"))
data08 %>% rowSums()

data00 <- data08 %>% 
  pivot_longer(cols=c("Coal":"Biofuels"), names_to = "Source", values_to = "TWh") 

ge <- data00 %>% 
  ggplot( aes(x=Year, y=TWh, fill=Source, text=Source)) +
    geom_area() +
    scale_fill_viridis(discrete = TRUE) +
    theme(legend.position="none") +
    theme_ipsum() +
    theme(legend.position="none")

ge <- ggplotly(ge) %>%
  layout(title = list(text = paste0('Global Primary Energy Consumption by Source',
                                    '<br>',
                                    '<sup>',
                                    'Using data from the BP Statistical Review of World Energy',
                                    '</sup>')))

```

```{r echo=FALSE}
ge
```



# Energy Burden
2020 | 12 | 31

Energy burden, the proportion of household income spent on energy, is closely related to energy insecurity, discussed previously.  In the map below, energy burden of low to moderate income households is displayed at the county level using data from the National Renewable Energy Laboratory.  For reference, high energy burdens are defined as greater than 6% of income, while severe energy burdens are those greater than 10% of income.  In the US, the average energy burden is approximately 3%, but for low income households, is nearly three times larger at about 8.6%.  Energy burdens are far from equally distributed across the US with  parts of Pennsylvania, West Virginia, Virginia, Kentucky and Tennessee all showing high energy burdens.  Communities in the Gulf Coast and Southeast, especially Louisiana, Mississippi, Alabama, Georgia, and north Florida up to the Carolinas also experience high energy burdens. These areas may have particularly high electric and heating bills because of regional climate patterns, leading to decreased energy affordability and higher energy burdens for LMI households. 
 

```{r include=FALSE}
data_dir <-"~/Documents/Dynamic Economics/EViews Graphs/R" 

databb <- read_excel(file.path(data_dir,
                               "Book5.xlsx"))
data(county.fips)


year_df <- databb[c("region", "ebb")]
counties <- county.fips %>% left_join(year_df, by=c('fips'='region'))
 ebb <- plot_usmap(data = counties, values = "ebb", labels=FALSE, color=NA, include=c("AL", "AZ", "AR", "CA", "CO", "CT", "DC", "DE", "FL", "GA","ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", 
          "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", 
          "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", 
          "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY")) + 
  scale_fill_continuous(low = "white", high = "blue4", 
                         name = "Burden (%)", label = scales::comma)+
  labs(title = "Energy Burden by County for LMI households",subtitle="Average energy expenditures as a percent of income", caption = "Source: National Renewable Energy Laboratory")+
    theme(legend.position = "right", panel.background = element_rect(colour = "black"),plot.title = element_text(size = 12.2, face = "bold"))
```


```{r echo=FALSE}
ebb
```


# Energy Insecurity 
2020 | 12 | 30

The U.S. Energy and Information Administration Residential Energy Consumption Survey, conducted every 4-5 years, looks at energy insecurity, which is defined by the criteria of reducing or forgoing food or medicine to pay energy costs, leaving the home at an unhealthy temperature, receiving disconnect or delivery stop notice from utilities, and the inability to use heating and/or cooling equipment to limit energy costs.  About 37 million households experienced energy insecurity in 2015, which is over 30% of American households.  Breaking this down by race, major disparity is observed, with only quarter of white households experiencing energy insecurity, while 44% of Hispanic households, 52% of black or African American households, and 54% of American Indian or Alaskan Native households experienced energy insecurity.

```{r include=FALSE}
datax <- read_excel(file.path(data_dir,
                               "Book3.xlsx"))


ggplot(datax, aes(x=as.factor(race), y=percent, fill = race)) + 
  geom_bar(stat = "identity", width=0.2)+
  scale_fill_grey(start = 0.25, end = 0.75) +
  coord_flip()

 
 eb <- datax %>%
  mutate(race = fct_reorder(as.factor(race), desc(percent))) %>%
  ggplot( aes(x=race, y=percent, fill=race)) +
    geom_bar(stat="identity", width=.3, show.legend = FALSE) +
    scale_fill_grey(start = 0.25, end = 0.75) +
    coord_flip() +
    xlab("Race") +
    expand_limits(y = c(0,.07))+
    theme(axis.title.x = element_text(size=11),  
                          axis.text.y = element_blank(),
                          axis.ticks.y=element_blank(),
                          plot.title = element_text(size = 12.2, face = "bold")) +    
   labs(title="Energy Insecurity Disproportionately Effects Ethnic Minorities",
              subtitle="Percent of households experiencing energy insecurity",
        caption="Data from 2015 RECS")+
    geom_hline(yintercept=.5, color="black", size=.3, alpha = 0.5, linetype="dashed")+
    geom_text(aes(label = race), position = position_stack(0.5), color = "white", size=3.2)+
    scale_y_continuous(name = "Percent of Households",labels = percent)
 
```

```{r echo=FALSE}
eb
```



# Electricity Generation by Source
2020 | 12 | 23

This plot shows US electricity generation since 1984 broken down by generation source using data from the US Energy Information Administration.  As you can see, coal was the primary source leading into the 21st century, but just before 2010, dropped off sharply and was overtaken by natural gas.  Around the same time, petroleum also began to fall.  On the other hand, renewables have been climbing steadily since the early 90s and the rate of increase took off in the mid 2000s.  Nuclear power saw an earlier increase, rising most before 2000, and leveling off from that point forward.  Going into the 2020s, it's expected that coal power will continue to drop off and renewables will make up the lost generation.  Nuclear power has huge potential to assist in replacing fossil fuels and as an excellent clean energy source, could be vital in reaching emission reduction goals in the future. 

```{r include=FALSE}
data2 <- read_excel(file.path(data_dir,
                                    "gen.xlsx"))

names(data2) <- data2[5,]
data2 <- data2[-c(1:5),]
data2$year <- as.numeric(data2$year)
data2$gen <- as.numeric(data2$gen)
data2$percent <- as.numeric(data2$percent)

data2 %>%
  ggplot( aes(x=year, y=gen, group=type, color=type)) +
    geom_line()

# Plot
plotdd <- data2 %>%
  ggplot( aes(x=year, y=gen, group=type, color=type)) +
    geom_line() +
    geom_point() +
    scale_color_viridis(discrete = TRUE) +
    labs(title="U.S. electricity generation by major energy source",
              subtitle="Billion kWh from utility-scale facilities")+
    theme_ipsum() +
    ylab("Billion kWh") +
    xlab("Year")+
    scale_color_manual(name="Source",
                       labels=c("Coal","Natural Gas","Nuclear", "Petroleum + other", "Renewables"),
                       values=c("red","orange","yellow", "green", "blue"))+
    transition_reveal(year)

```


```{r echo=FALSE}
plotdd
```




# White Christmas
2020 | 12 | 22

It's that time of year!  In this graph, I used 2016 data from the National Oceanic and Atmospheric Administration which estimated the probability of a white Christmas based on data collected over the past 3 decades.  I used several new packages for this, including "usmap", "rnaturalearthdata", and "sf". Unfortunately, I was lacking data from the west half of the US, so the data points were not as dense as I had hoped.  I also think in the future, it would be interesting to try to find a way to map this over time, so the change in probability from year to year can be observed through animation or a year slider.  Anyway, the results here are no surprise, with northern areas much more likely to experience snow.  Of course, whether or not it snows in your region will depend highly on local weather patterns on or before the 25th, which can be found at Weather.gov. Happy holidays!     

```{r include=FALSE}

data <- read_excel(file.path(data_dir,
                               "snow.xlsx"))
`%notin%` <- Negate(`%in%`)

data <- data %>% drop_na() %>% 
 filter(state %notin% c("AS","FM", "MP", "PR", "PW", "UM", "GU", "MH", "VI"))

duplicated(data[,1:2])


transform <- usmap_transform(data)
glimpse(transform)

unique(data$State)

map <- plot_usmap() +
  geom_point(data = transform, aes(x = lon.1, y = lat.1, col = prob), size=2.2, alpha=.8) +
  labs(title = "Probability of a White Christmas by Location",
       subtitle = "Source: National Oceanic and Atmospheric Administration, 2016",
       col = "Probability") +
  theme(plot.title = element_text(size = 14, face = "bold"), legend.position = "right")

```

```{r echo=FALSE}
map
```



# TED Spread
2020 | 12 | 20

This graph is a simple plot of the TED Spread from 1986 until present day, using data from FRED.  The TED spread is the difference between the three-month Treasury bill and the three-month LIBOR based in US dollars, or in other words, the difference between the interest rate on short-term US government debt and the interest rate on interbank loans.  It can be used as an indicator of the solvency of financial institutions, monetary liquidity, and percieved risk of the financial system and as a result, is considered important to investment analysis.  To make this graph, I used the package "dygraphs" which displays data point values on the graph when hovered over and allows the viewer to adjust the x axis as desired. 




```{r include=FALSE}

data_dirxx <-"~/Documents/Dynamic Economics/EViews Graphs/Part I" 
data11 <- read_excel(file.path(data_dirxx,
                               "TED.xls"))

names(data11) <- data11[10,]
data11 <- data11[-c(1:10),-c(3:5)]

data11$observation_date <-  excel_numeric_to_date(as.numeric(as.character(data11$observation_date)), date_system = "modern")
data11$spread <- as.numeric(data11$spread)

dona <- xts(x = data11$spread, order.by = data11$observation_date)

p <- dygraph(dona,
             main = "TED Spread",
             ylab = "Spread(%)",
             xlab = "Date") %>%
  dyOptions(labelsUTC = TRUE, fillGraph=TRUE, fillAlpha=0.1, drawGrid = FALSE, colors="#D8AE5A") %>%
  dyRangeSelector() %>%
  dyCrosshair(direction = "vertical") %>%
  dyHighlight(highlightCircleSize = 5, highlightSeriesBackgroundAlpha = 0.2, hideOnMouseOut = FALSE)  %>%
  dyRoller(rollPeriod = 1) %>%
  dyShading(from="1990-07-01", to="1991-03-01", axis = "x") %>% 
  dyShading(from="2001-03-01	", to="2001-11-01", axis = "x") %>% 
  dyShading(from="2007-12-01", to="2009-06-01", axis = "x") %>% 
  dyShading(from="2020-02-01", to="2020-12-01	", axis = "x")

```

```{r echo=FALSE}
p
```



# Baby Names
2020 | 12 | 20

A fun plot made using data from the R package "babynames".  I selected my name, as well as my sister and mothers names to plot from 1880 until present day.  Frances was most popular around 1920, while Grace peaked in popularity around 2000, a few years after I was born.  Kimberly experienced the most dramatic spike in popularity in the late 1960's, which was around the time my mother was born.  Looking at this data, it appears that my mother had the trendiest name, while I was named slightly ahead of the trend.  Interestingly, Frances and Grace seem to follow a similar trend from 1880 - 1980.

```{r include=FALSE}
don <- babynames %>% 
  filter(name %in% c("Grace", "Frances", "Kimberly")) %>%
  filter(sex=="F")
  
# Plot
plotd <- don %>%
  ggplot( aes(x=year, y=n, group=name, color=name)) +
    geom_line() +
    geom_point() +
    scale_color_viridis(discrete = TRUE) +
    ggtitle("Popularity of American names since 1880") +
    theme_ipsum() +
    ylab("Number of babies born") +
    transition_reveal(year)
```

```{r echo=FALSE}
plotd
```







